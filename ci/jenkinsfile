library 'glovo-jenkins-pipelines@v3.4.3'

withAuth.secretText("ARTIFACTORY_PASSWORD") { password ->
    env.ANDROID_SDK_ROOT = '/opt/android-sdk/'
    env.ORG_GRADLE_PROJECT_artifactory_user = 'jenkins'
    env.ORG_GRADLE_PROJECT_artifactory_key = password

    pipeline {
        parameters {
            booleanParam defaultValue: false, description: 'Perform the publication to artifactory', name: 'Publish'
        }
        agent {
            node {
                label 'mobile'
            }
        }
        stages {
            stage('Build plugins') {
                steps {
                    sh "./gradlew --stacktrace clean build"
                }
                post {
                    always {
                        junit "**/build/test-results/**/*.xml"
                    }
                }
            }
            stage('Build Demos') {
                steps {
                    dir('demo/android') {
                        sh "./gradlew --stacktrace clean build"
                    }
                }
            }
            stage('Publish SDK artifacts') {
                when {
                    expression {
                        params.Publish
                    }
                }
                steps {
                    sh "./gradlew --stacktrace artifactoryPublish"
                }
            }
        }
    }
}
